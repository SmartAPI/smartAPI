{% extends "main.html" %}
{% block extra_head %}
{% endblock %}
{% block content %}
{% include "header.html" %}
<style>
[v-cloak] > * { display:none; }
</style>
  {% raw %}
    <main>
      <!-- Loading Screen -->
      <div id="loading-overlay" class="center-align" style="background-color: rgba(18, 52, 84, 0.5); cursor: default;">
        <div class="center-align" style="padding-top: 300px;">
          <object width="100px"  alt="Loading" data="/static/img/fly.gif" class=""></object>
          <h3 class="white-text logoFont">Loading...</h3>
        </div>
      </div>
    <div id="app" style="height: 100%;" class="white" v-cloak>
        <div class="row full-height">
            <div class="col l2 s12 hide-on-med-and-down hide-on-small-only sidebar">
                <h5 style="padding-top:100px" class="blue-text center"> Filters</h5>
                <ul class="collapsible">
                  <li>
                    <div class="collapsible-header blue-grey white-text">
                      <small>Tags</small>
                    </div>
                    <div class="collapsible-body noPadding">
                      <div class="collection">
                          <a :class="{ disable: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), active: tag.active, blue: tag.active  && tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase(), green: tag.active  && tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() , 'white-text': tag.active}" v-for="tag in tags" href="#!" class="collection-item smallFont" @click.prevent="tag.active = !tag.active;search(query); googleAnalytics('Registry_Tag', tag.name)">{{tag.name}}  <span class="bold">({{tag.count}})</span></a>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="collapsible-header blue-grey white-text center-align">
                      <small>Owners</small>
                    </div>
                    <div class="collapsible-body noPadding">
                      <div class="collection">
                          <a :class="{ active: author.active, blue: author.active }" v-for="author in authors" href="#!" class="collection-item smallFont " @click.prevent="author.active = !author.active;search(query); googleAnalytics('Registry_Author', author.name)">{{author.name}}  <span class="bold">({{author.count}})</span> <span class="red-text" v-if="userInfo && author.name === userInfo.name">(Me)</span></a>
                      </div>
                    </div>
                  </li>
                </ul>
                <!-- Popular tags -->
                <ul class="collection" style="margin-top:100px;">
                  <div class="collection-header orange white-text center padding20">
                    <small>Popular Tags</small>
                  </div>
                  <template v-for="pop in popularTags">
                    <a :class="{ active: pop.active, blue: pop.active }" @click.prevent="matchTagAndSearch(pop.name);search(query); googleAnalytics('Registry_Tag', pop.name)" href="#!" class="collection-item" style="padding:4px;" >
                      <small v-text="'#'+pop.name"></small>
                    </a>
                  </template>
                </ul>
            </div>
            <div class="col l10 s12 ">
                <div class="row">
                    <form class="col s12 center-align" @submit.prevent="search(query)" id="api_search_form">
                      <template v-if='specialTagsUI'>
                        <div  class="col s12 l3 input-field center-align">
                          <a class='tooltipped' data-position="bottom" :data-tooltip="'Learn More about '+specialTagName" :href="specialTagURL" target="_blank" style="cursor: pointer !important;">
                            <img v-if="specialTagsUI" width="auto" style="max-height: 40px; max-width:100%;" height="auto" :src="specialTagImage"  :alt="specialTagName"/>
                          </a>
                        </div>
                        <div class="input-field col s12 l6">
                            <input aria-required="false" required='false' id="search_query" type="text" v-model="query" name="query" placeholder="Enter any query term here" class="browser-default margin20 grey lighten-5 blue-grey-text lighter" style="width: 50%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-medium) 2px solid;">
                        </div>
                      </template>
                      <template v-else>
                        <div class="input-field col s12 l6 offset-l3">
                            <input aria-required="false" required='false' id="search_query" type="text" v-model="query" name="query" placeholder="Enter any query term here" class="browser-default margin20 grey lighten-5 blue-grey-text lighter" style="width: 50%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-medium) 2px solid;">
                        </div>
                      </template>

                        <div class="col s12 selected-tags">
                            <div class="chip" v-for="tag in tags" v-if="tag.active" :class="{ green: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), 'white-text': tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() }">
                              #{{tag.name}}
                                <i v-if="tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase()" class="close material-icons" @click="tag.active = false;search(query)">close</i>
                            </div>
                            <div class="chip" v-for="author in authors" v-if="author.active">
                                #{{author.name}}
                                <i class="close material-icons" @click="author.active = false;search(query)">close</i>
                            </div>
                            <div class="chip" v-for="pop in popularTags" v-if="pop.active">
                                #{{pop.name}}
                                <i class="close material-icons" @click="pop.active = false;search(query)">close</i>
                            </div>
                        </div>
                        <div class="col s12">
                            <button type="submit" @click="googleAnalytics('Registry_Searches',query)" class="waves-effect waves-light blue btn">search</button>&nbsp;&nbsp;&nbsp;
                            <a class="blue btn" href="/registry">clear</a>
                        </div>
                    </form>
                </div>
                <div class="row search-results" id="tippyParentCopy">
                    <div class="col s12" id="tippyParent">
                        <div class="blue-grey-text">
                           <div class="row">
                             <div class="col s5 m10">
                               Total APIs: <span class="blue-text">{{total}}</span>
                               <button :data-clipboard-text='shareURL' @click.prevent="googleAnalytics('Registry_SharedURL', window.location.search );" v-if="shareURLButtonVisible" class="smallButton grey copyBtn" title='Copy to clipboard'>
                                 <i class="fa fa-clipboard" aria-hidden="true"></i> Copy Search URL
                               </button>
                             </div>
                             <div class="col s5 m2">
                               <select class="browser-default" @change='sortResults($event)'>
                                 <option value="" disabled selected>Sort By</option>
                                 <option value="Search Relevance">Relevance</option>
                                 <option value="Alpabethically A-Z">Alpabethically A-Z</option>
                                 <option value="Alpabethically Z-A">Alpabethically Z-A</option>
                                 <option value="Recently Updated">Recently Updated</option>
                               </select>
                             </div>
                           </div>
                        </div>
                        <template v-if="total === 0">
                          <div class="card">
                            <div class="card-content center">
                              <i class="fa fa-exclamation-circle fa-2x grey-text" aria-hidden="true"></i>
                              <h5 class="grey-text">Your Search Returned No Results</h5>
                            </div>
                          </div>
                        </template>
                        <div class="card context" v-for="(api,index) in paginatedApis">
                            <div class="card-content ">
                                <span class="card-title">
                                  <span class="blue-grey-text bold">
                                    {{api.info.title}}
                                  </span>
                                  <span class="versionBadge grey">
                                    V.{{api.info.version}}
                                  </span>
                                  <span v-if=" api.hasOwnProperty('openapi') " class="versionBadge green">
                                    OAS3
                                  </span>
                                  <span v-else-if=" api.hasOwnProperty('swagger') " class="versionBadge blue">
                                    Swagger2
                                  </span>
                                  <a style="cursor: pointer !important;" href="/dashboard" v-if="userInfo && api._meta.github_username === userInfo.login " class="versionBadge light-blue">
                                    My&nbsp;API
                                  </a>
                                  <a title="This API is being used by BioThings Explorer" style="cursor: pointer !important;" v-if="isUsedByBTE(api.info.title)" target="_blank" href="https://biothings.io/explorer" class="versionBadge orange darken-4">
                                    <img height="18px;" src="http://biothings.io/static/img/biothings-explorer-64.png"/>&nbsp;BioThings Explorer
                                  </a>
                                  <status :api='api' ></status>
                                </span>
                                <template v-if="api.info.description && api.info.description.length > 500">
                                  <description :text='api.info.description'></description>
                                </template>
                                <template v-else>
                                  <div class="blue-grey-text" v-html="compiledMarkdown(api.info.description || '')"></div>
                                </template>
                                <hr style="border: dotted 1px #e8e8e8 !important;"/>
                                <div class="full-width grey-text">
                                  <template v-for="(tag,index) in api.tags">
                                    <a  href="#!" @click.prevent="matchTagAndSearch(tag.name);search(query);googleAnalytics('Registry_Tag', tag.name)" class="link">
                                      <small>#{{tag.name}}</small>
                                    </a>
                                    <span v-if="index !== api.tags.length-1">, </span>
                                  </template>
                                </div>
                            </div>
                            <!-- TOGGLE DETAILS -->
                            <div class="card-action grey lighten-3" v-if="apis.length > 1">
                                <a style="border-radius: 20px;" class="btn blue white-text smallFont" href="#" @click.prevent="api.showDetails = !api.showDetails; googleAnalytics('Registry_APIs',api.info.title)" v-text="api.showDetails?'HIDE DETAILS':'SHOW DETAILS'"></a>
                            </div>
                            <div class="card-content detailsBack" v-if="api.showDetails || apis.length === 1">
                              <div class="row white" style="width:60%">
                                <div class="col s12 right-align">
                                  <small class="grey-text">Updated: </small><small class="blue-grey-text">{{ getDate(api._meta.timestamp) }}</small>
                                </div>
                                <div class="col s12 center">
                                  <h6 class="grey-text"><span class="blue-grey-text bold">
                                    {{api.info.title}}
                                  </span> V {{api.info.version}}</h6>
                                </div>
                                <div class="col s12 center">
                                  <template v-for='name in checkForName(api)'>
                                    <template v-if="name != 'Name Unavailable'">
                                      <small class="blue-grey-text">by</small>
                                      <small class="grey-text">
                                        <i class="fa fa-user" aria-hidden="true"></i> {{ name }}
                                      </small>
                                    </template>
                                  </template>
                                </div>
                                <div class="col s12 center">
                                  <small class="blue-grey-text">SmartAPI ID</small>
                                  <a class="link" target="_blank" v-bind:href='"/api/metadata/"+api._id'>
                                    <small>
                                      <span :id="'id'+api._id" :value="api._id">{{api._id}}</span> <i class="fa fa-external-link" aria-hidden="true"></i>
                                    </small>
                                  </a>
                                  <button class="smallButton grey copyBtn" :data-clipboard-text="api._id">
                                      <i class="fa fa-clipboard" aria-hidden="true"></i>
                                  </button>
                                </div>
                                <div class="col s12 center">
                                  <small class="blue-grey-text">Metadata URL</small>
                                  <a class="link" target="_blank" v-bind:href='api._meta.url'>
                                    <small>{{_.truncate(api._meta.url)}} <i class="fa fa-external-link" aria-hidden="true"></i></small>
                                  </a>
                                  <button class="smallButton grey copyBtn" :data-clipboard-text="api._meta.url">
                                      <i class="fa fa-clipboard" aria-hidden="true"></i>
                                  </button>
                                </div>
                                <div class="col s12 center">
                                  <small class="blue-grey-text">SmartAPI Registry URL</small>
                                  <a class="link" target="_blank" v-bind:href='"?q="+api._id'>
                                    <small><span :id="'url'+api._id" :value="api._id">http://smart-api.info/registry?q={{api._id}}</span></small>
                                  </a>
                                  <button class="smallButton grey copyBtn" :data-clipboard-text="'http://smart-api.info/registry?q='+api._id">
                                      <i class="fa fa-clipboard" aria-hidden="true"></i>
                                  </button>
                                </div>
                                <div class="col s12 center" style="padding:20px;">
                                  <a class="btn green smallFont"
                                     v-bind:href='"/ui/"+api._id' @click="googleAnalytics('Registry_Documentation', api.info.title)">
                                     View API Documentation
                                  </a>
                                  <a class="btn blue smallFont"
                                     v-bind:href='"/editor/"+api._id'>
                                     Edit <i class="fa fa-pencil" aria-hidden="true"></i>
                                  </a>
                                </div>
                              </div>
                                <template v-if=" api.hasOwnProperty('openapi') ">
                                  <h6 class="center blue-grey-text">(<span v-text="getOperations(api).length"></span>) Operations</h6>
                                  <table  class="bordered grey lighten-5" style="margin: 20px 0px;">
                                    <col width="10%">
                                    <col width="30%">
                                    <col width="60%">
                                      <tr v-for="operation in getOperations(api)">
                                        <td class="center" style="white-space: pre-wrap; word-break: break-word;padding:3px;" :class="operationStyling(operation.method)">
                                          <small>{{operation.method}}</small>
                                        </td>
                                        <td style="white-space: pre-wrap; word-break: break-word;padding:3px;">
                                          <small class="blue-text bold">{{operation.path}}</small>
                                        </td>
                                        <td class="blue-grey-text" style="padding:3px;">
                                          <small>{{operation.summary}}</small>
                                        </td>
                                      </tr>
                                  </table>
                                </template>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col s12 m6 l6">
                                <ul class="pagination">
                                    <li :class="{ disabled: page <= 1 }">
                                        <a href="#" @click.prevent="prevPage()"><i class="material-icons">chevron_left</i> Previous</a>
                                    </li>
                                    <li :class="{ active: page == n, blue: page == n, 'white-text': page == n  }" v-for="n in pages">
                                        <a href="#" @click.prevent="page = n">{{n}}</a>
                                    </li>
                                    <li :class="{ disabled: page >= pages }">
                                        <a href="#" @click.prevent="nextPage()">Next <i class="material-icons">chevron_right</i></a>
                                    </li>
                                </ul>
                            </div>
                            <div class="col s12 m6 l6 right-align">
                                Per page:
                                <select class="perPage" v-model="perPage" @change="calculatePages" id="perPage">
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </main>
    {% endraw %}
{% include "footer.html" %}
{% endblock %}


{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="/static/js/clipboard.js"></script>
<script src="/static/js/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-139873613-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-139873613-1', {
    'custom_map': {
      // 'dimension1': 'registrytag','dimension2':'registryapi','dimension3':'registryurl','dimension4':'registrysearch',
      'dimension5':'registryResults',
      'metric1':'registry-item'
    }
  });
</script>
<script>

const store = new Vuex.Store({
    state: {
      'analytics':Object,
      'tags':Array
    },
    strict: true,
    mutations: {
      saveAnalytics(state,payload){
        state.analytics = payload['analytics'];
      },
    },
    getters:{
      // exposed as store.getters.nameOfGetter
      getHitsFor: (state) => (apiname) => {
        let data={'labels':[],'datasets':[]};
        let label = '';
        let dataArray=[];

        for (var i = 0; i < state.analytics.length; i++) {
          if (state.analytics[i][1].toLowerCase() === apiname.toLowerCase()) {
            label = state.analytics[i][0].toUpperCase();
            data.labels.push(label);
            let number = state.analytics[i][2];
            dataArray.push(number)
          }

        }
        data.datasets.push({'label':"Users",'data':dataArray,'backgroundColor': ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],})
        // console.log('user interactions...',data)
        return data
      },
      getTags:(state)=>{
        let pop = []
        for (var i = 0; i < state.analytics.length; i++) {
          if (state.analytics[i][0] ==='tag') {
            pop.push({'name':state.analytics[i][1],'active':false,'count':state.analytics[i][2]})
          }
        }
        return pop;
      }

    }
  });

Vue.component('status', {
  data: function(){
    return{
      status:'',
      clss:'',
    }
  },
  props: ['api'],
  methods:{
    getStatus(api){
      let self = this;
      if (api['_meta'].hasOwnProperty('uptime_status')) {
        let stat = api['_meta']['uptime_status'];
        switch (stat) {
          case 'unknown':
            self.status = 'UNKNOWN';
            self.clss = 'orange';
            break;
          case 'good':
            self.status = 'PASS';
            self.clss = 'green';
            break;
          case 'bad':
            self.status = 'FAIL';
            self.clss = 'red';
            break;
          case 'incompatible':
            self.status = 'INCOMPATIBLE';
            self.clss = 'blue';
            break;
          default:
          self.status = '';
          self.clss = 'grey';
        }
      }
    },
    setTooltip(){
      tippy( '.apiStatus', {
        content: `<div>
                    <table>
                      <tbody>
                        <tr>
                          <td class='green-text center'>
                            <b>PASS</b>
                          </td>
                          <td class="blue-grey-text">
                            Your OpenAPI V3 API endpoints provide examples and all return code 200.
                          </td>
                        </tr>
                        <tr>
                          <td class='red-text center'>
                            <b>FAIL</b>
                          </td>
                          <td class="blue-grey-text">
                            Your OpenAPI V3 API endpoints provide examples but return code other than 200.
                          </td>
                        </tr>
                        <tr>
                          <td class='orange-text center'>
                            <b>UNKNOWN</b>
                          </td>
                          <td class="blue-grey-text">
                            None of your OpenAPI V3 API endpoints provide examples and cannot be tested. <a href='/faq#api-monitor' target="_blank">Learn more about how to to enable API status check </a>.
                          </td>
                        </tr>
                        <tr>
                          <td class='blue-text center'>
                            <b>INCOMPATIBLE</b>
                          </td>
                          <td class="blue-grey-text">
                            Your API's specification does not match OpenAPI V3 specification and will not be tested. Use our guide to learn how to upgrade your metadata to OpenAPI V3 <a href="/guide" target="_blank">here</a>.
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>`,
        placement: 'left',
        theme:'light',
        trigger:'click',
        sticky:true,
        interactive:true,
      });
    }
  },
  mounted: function(){
    this.setTooltip();
    this.getStatus(this.api);
  },
  template: `<div v-show='status' class="apiStatus" title="Click to learn more">
              <div class="blue-grey-text">Status</div>
              <div :class="clss" v-text='status'></div>
             </div>`
});


  new ClipboardJS('.copyBtn');
      ClipboardJS.isSupported();

  Vue.component('description', {
    data: function(){
      return{
        result:null,
        fullTXT:false
      }
    },
    props: ['text'],
    methods:{
      compileMDWN: function(mdtext){
        this.result = marked(mdtext, { sanitize: true });
        return this.result;
      }
    },
    mounted: function(){
      this.compileMDWN(this.text)
    },
    template: `<div>
                <div class="expandContainer" v-bind:class="{'max-height-none' : fullTXT, 'max-height-200': !fullTXT}">

                  <div class="center">

                    <a class="btn grey lighten-1 expandButtonLess" v-if="fullTXT" @click.prevent="fullTXT = !fullTXT;">
                      Collapse
                    </a>
                  </div>

                  <div class="blue-grey-text" v-html="result"></div>

                  <div class="center">
                    <a class="btn grey lighten-1 expandButtonLess" v-if="fullTXT" @click.prevent="fullTXT = !fullTXT;">
                      Collapse
                    </a>
                  </div>

                  <div v-if="!fullTXT" class="whiteFadeBox center">
                    <a class="btn grey lighten-1 expandButtonMore" v-if="!fullTXT" @click.prevent="fullTXT = !fullTXT;">Click to expand</a>
                  </div>
                </div>
              </div>`
  });


  var app = new Vue({
      el: '#app',
      store: store,
      data: function(){
        return {
            total: 0,
            apis: [],
            tags:[],
            query: '',
            page: 1,
            pages: 1,
            perPage: 20,
            keywords:'',
            specialTagsUI: false,
            specialTagName: '',
            specialTagImage: '',
            specialTagURL: '',
            specialTagOriginalName: '',
            userInfo: {},
            context:{},
            authors: [],
            shareURL:'',
            shareURLButtonVisible: false,
            sort: 'Relevance',
            bteapis:[],
            popularTags:[]
        }
      },
      methods: {
          isUsedByBTE(name){
            var self = this;
            if (self.bteapis.includes(name) ) {
              return true
            }else{
              return false
            }
          },
          getBTEapis(){
            var self = this;
            axios.get('https://biothings.io/explorer_beta/api/v2/metadata/apis').then(res=>{
              if (res.data.api) {
                self.bteapis = res.data.api
              }
            }).catch(err=>{
              throw err;
            });
          },
          googleAnalytics(category, label){
            // console.log('category',category,label)
            // gtag('event','click',{'event_category':'general','event_label':label,'event_value':1})

            switch (category) {
              case 'Registry_Tag':
                gtag('event','click',{'event_category':'tag','event_label':label,'event_value':1})
                break;
              case 'Registry_Author':
                gtag('event','click',{'event_category':'author','event_label':label,'event_value':1})
                break;
              case 'Registry_APIs':
                gtag('event','click',{'event_category':'expanded','event_label':label,'event_value':1})
                break;
              case 'Registry_SharedURL':
                gtag('event','click',{'event_category':'shared','event_label':label,'event_value':1})
                break;
              case 'Registry_Searches':
                gtag('event','click',{'event_category':'searched','event_label':label,'event_value':1})
                break;
              case 'Registry_Documentation':
                gtag('event','click',{'event_category':'documentation','event_label':label,'event_value':1})
                break;
              default:
              gtag('event','click',{'event_category':'general','event_label':label,'event_value':1})
            }
          },
          sortResults(e){
            this.sort = e.target.value;
          },
          getDate(timestamp){
            var date = moment(timestamp).format("LL");
            return date;
          },
          handleDescriptionClick(event, show){
            if (show) {
              event.target.style.maxHeight = 'none';
              if (event.target.children[1]) {
                event.target.children[1].hidden = true;
              }
            }else{
              event.target.style.maxHeight = '200px';
              if (event.target.children[1]) {
                event.target.children[1].hidden = false;
              }
            }
          },
          matchTagAndSearch: function(tagName){
            var self = this;
            for (var i = 0; i < self.tags.length; i++) {
              if (self.tags[i].name === tagName) {
                self.tags[i].active = true;
                self.search(self.tags[i].name);
              }
            }
          },
          checkForName: function(api){
            if (_.get(api, 'info.contact.name')) {
              return [api.info.contact.name];
            }
            else{
              return ['Name Unavailable'];
            }
          },
          showHideDetails: function(event){
            //toggle show/hide text on details link per card
            let text = $(event.target).text().trim().toLowerCase();
            if(text === 'show details'){
              event.target.innerHTML = 'hide details';
            }
            else if(text === 'hide details'){
              event.target.innerHTML = 'show details';
            }
          },
          operationStyling: function(op){
            //styles operations based on type
            switch( op.substr(0,3) ){
                  case 'GET' :
                    return 'bold light-blue darken-1 white-text operation';
                    break;
                  case 'POS' :
                    return 'bold light-green white-text operation';
                    break;
                  case 'PUT' :
                    return 'bold amber lighten-2 white-text operation';
                    break;
                  case 'DEL' :
                      return 'bold deep-orange darken-1 white-text operation';
                      break;
                  case 'HEA' :
                      return 'bold deep-purple lighten-1 white-text operation';
                      break;
                  case 'PAT' :
                      return 'bold brown lighten-1 white-text operation';
                      break;
                  case 'PAR' :
                      return 'bold teal lighten-1 white-text operation';
                      break;
                  default:
                     return 'bold gray lighten-1 white-text operation'
                      break;
            }
          },
          loading_start: function(){
              $('#loading-overlay').show();
          },
          loading_end: function(){
              $('#loading-overlay').hide();
          },
          getKeywords: function(){
            var self= this;
            // Read the keyword
            self.keywords = $("input[name='query']").val();
            self.mark(self.keywords);
          },
          mark: function(kw){
            //unmark and mark current search
            var self= this;
            $(".context").unmark({
              done: function() {
                $(".context").mark(kw);
              }
            });
          },
          refreshApis: function(){
              var self = this;
              self.handleContext(self.context);
              //check for existing query in url string
              self.checkforQuery();
              let query = self.query;
              if(!self.query){
                query="__all__"
              }
              var params = {
                  "params": {
                      "q": encodeURIComponent(query),
                      'fields': 'info,_meta,paths.path,paths.pathitem.get.summary,paths.pathitem.post.summary,paths.pathitem.delete.summary,paths.pathitem.patch.summary,paths.pathitem.put.summary,paths.pathitem.head.summary,paths.pathitem.put.summary,options.pathitem.head.summary,paths.pathitem.put.summary,paths.pathitem.trace.summary,paths.pathitem.get.description,paths.pathitem.post.description,paths.pathitem.delete.description,paths.pathitem.patch.description,paths.pathitem.put.description,paths.pathitem.head.description,paths.pathitem.put.description,options.pathitem.head.description,paths.pathitem.put.description,paths.pathitem.trace.description,tags,openapi,swagger,'
                  }
              }
              var filters = self.getQueryFilters();
              if (Object.keys(filters).length !== 0){
                params["params"]["filters"] = filters;
              }
              self.loading_start();
              axios.get("/api/query?size=100", params).then(function(response){
                  self.loading_end();
                  self.apis = response.data.hits;
                  self.total = response.data.total;
                  self.calculatePages();
              }).catch(err=>{
                throw err;
                self.loading_end();
              });
          },
          loadFilters: function (){
              var self = this;
              axios.get('/api/suggestion?field=tags.name').then(function(response){
                  self.tags = _.map(response.data.field_values.buckets, function(item){
                      return {'name':item.key, 'count': item.doc_count, 'active': false};
                  });
                  axios.get('/api/suggestion?field=info.contact.name').then(function(response){
                      self.authors = _.map(response.data.field_values.buckets, function(item){
                          return {'name':item.key, 'count': item.doc_count, 'active': false};
                      });
                      //When all filters all loaded
                      //share url params depend on filters being loaded
                      self.refreshApis();
                  });

              });
          },
          getQueryFilters: function(){
              var filters = [];
              var authorFilters = [];
              var finalFilters = {};
              this.tags.forEach(function(item){
                if (item.active)
                    filters.push(item.name);
                });
              if (filters.length > 0){
                finalFilters['tags.name.raw'] = filters;
              }

              this.popularTags.forEach(function(item){
                if (item.active && !filters.includes(item.name))
                    filters.push(item.name);
                });
              if (filters.length > 0){
                finalFilters['tags.name.raw'] = filters.concat(filters);
              }

              this.authors.forEach(function(item){
                if (item.active){
                  authorFilters.push(item.name);
                }
                });
              if (authorFilters.length){
                finalFilters['info.contact.name.raw'] = authorFilters;
              }

              return finalFilters;
          },
          searchForTags: function(tagName){
            var self = this;
            for (var i = 0; i < self.tags.length; i++) {
              if (self.tags[i].name === tagName) {
                self.tags[i].active = !self.tags[i].active;
                self.search();
              }
              else{
                self.search();
              }
            }
          },
          buildShareURL: function(q){
            var filters = [];
            var authorFilters = [];
            var finalFilters = '';
            var finalAuthorFilters ='';
            var finalURL = window.location.origin+window.location.pathname;
            // Collect TAGS
            this.tags.forEach(function(item){
              if (item.active)
                  filters.push(item.name);
              });
            // Collect Owners
            this.authors.forEach(function(item){
              if (item.active){
                authorFilters.push(item.name);
              }
            });
            //Detect QUERY
            if (q !== '__all__') {
              finalURL = finalURL+'?q='+q;
              //if any tags are actuve
              if(authorFilters.length || filters.length){
                finalURL = finalURL+"&";
              }
            }
            //if tags active but no query
            else if(authorFilters.length || filters.length){
              finalURL = finalURL+"?";
            }
            // if BOTH filters exists
            if (filters.length && authorFilters.length) {
              finalFilters = filters.join(',')
              finalURL = finalURL+"tags="+finalFilters;

              finalAuthorFilters = authorFilters.join(',')
              finalURL = finalURL+"&owners="+finalAuthorFilters;
            }
            // if Owners Exist but no Tags
            else if (!filters.length && authorFilters.length) {
              finalAuthorFilters = authorFilters.join(',')
              finalURL = finalURL+"owners="+finalAuthorFilters;
            }
            // if Tags exists but no owners
            else if (filters.length && !authorFilters.length) {
              finalFilters = filters.join(',')
              finalURL = finalURL+"tags="+finalFilters;
            }

            this.shareURL =finalURL;
            //HTML5 change url history
            window.history.pushState({"html":'content',"pageTitle":'SmartAPI'},"", finalURL);
            this.shareURLButtonVisible = true;
          },
          search: function (query) {
              var self = this;
              self.context= {{Context}};
              if (!self.context.Special && !query){
                query = $('#search_query').val();
                query = query || "__all__";
              }
              else if (self.context.Special && !query) {
                query = query || "__all__";
                self.handleSpecialTags(self.context.Tags[0]);
              }
              if (query) {
                  self.googleAnalytics('Registry_Searches',query)
                  var params = {
                      "params": {
                          "q": encodeURIComponent(query),
                          'fields': 'info,_meta,paths.path,paths.pathitem.get.summary,paths.pathitem.post.summary,paths.pathitem.delete.summary,paths.pathitem.patch.summary,paths.pathitem.put.summary,paths.pathitem.head.summary,paths.pathitem.put.summary,options.pathitem.head.summary,paths.pathitem.put.summary,paths.pathitem.trace.summary,paths.pathitem.get.description,paths.pathitem.post.description,paths.pathitem.delete.description,paths.pathitem.patch.description,paths.pathitem.put.description,paths.pathitem.head.description,paths.pathitem.put.description,options.pathitem.head.description,paths.pathitem.put.description,paths.pathitem.trace.description,tags,openapi,swagger,'
                      }
                  };
                  var filters = this.getQueryFilters();
                  if (Object.keys(filters).length !== 0){
                    params["params"]["filters"] = filters;
                  }
                  this.loading_start();
                  // Share search URL
                  self.buildShareURL(query);

                  $(".context").unmark();
                  axios.get('/api/query?size=100', params).then(function (response) {
                      self.loading_end();
                      $(".context").unmark();
                      self.apis = response.data.hits;
                      self.handleContext(self.context);
                      self.total = response.data.total;
                      self.page = 1;
                      self.calculatePages();
                  }).catch(err=>{
                    throw err;
                    self.loading_end();

                  });
              }
          },
          calculatePages: function () {
              this.pages = Math.ceil(this.apis && this.apis.length / this.perPage);
          },
          prevPage: function () {
              if (this.page > 1)
                  this.page -= 1
          },
          nextPage: function () {
              if (this.page < this.pages)
                  this.page += 1
          },
          compiledMarkdown: function (mdtext) {
              return marked(mdtext, { sanitize: true })
          },
          toggleDetails: function (api) {
            this.$set(api, 'showDetails', !api.showDetails);
          },
          validateFields(path){
            let paths = ['GET','POST','PUT','DELETE','PATCH','TRACE','HEAD','CONNECT'];
            if (paths.includes(path)) {
              return path;
            }else if (path === "PARAMETERS") {
                return 'GET';
            }
          },
          getOperations: function (api, raw=false) {
            var self= this;
              var operations = [];
              if (raw) {
                  for(var path in api.paths) {
                      for(var method in api.paths[path]) {
                          operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': path['pathitem'][method].summary, 'path': path })
                      }
                  }
              }else{
                  api.paths.forEach(function(path){
                      for(var method in path['pathitem']) {
                        if (path['pathitem'][method].hasOwnProperty('summary')) {
                          operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': path['pathitem'][method].summary, 'path': path.path })
                        }else if (path['pathitem'][method].hasOwnProperty('description')) {
                          operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': path['pathitem'][method].description, 'path': path.path })
                        }
                      }
                  })
              }
              return operations;
          },
          getUserInfo: function(){
            var self= this;
            axios.get('/user').then(response=>{
              self.userInfo = response.data;
            }).catch(err=>{
              throw err;
            })
          },
          handleRegularTags: function(rTags){
            var self = this;
              self.specialUI = false;
              for (var i = 0; i < rTags.length; i++) {
                for (var x = 0; x < self.tags.length; x++) {
                  if (rTags[i].toLowerCase() === self.tags[x].name.toLowerCase()) {
                    self.tags[x].active = true;
                  }
                }
              }
          },
          handleOwnerTags: function(rTags){
            var self = this;
              self.specialUI = false;
              for (var i = 0; i < rTags.length; i++) {
                for (var x = 0; x < self.authors.length; x++) {
                  if (rTags[i].toLowerCase() === self.authors[x].name.toLowerCase()) {
                    self.authors[x].active = true;
                  }
                }
              }
          },
          handleContext: function(context){
            // console.log(context);
            if (context.Special) {
              this.handleSpecialTags(this.context.Tags[0]);
            }
            if (!context.Special && !_.isEmpty(context.Tags)) {
              this.handleRegularTags(this.context.Tags);
            }
            if (!context.Special &&  !_.isEmpty(context.Owners)) {
              this.handleOwnerTags(this.context.Owners);
            }
          },
          handleSpecialTags: function(tagname){
            var self = this;
              self.specialTagsUI = true;
              self.specialTagOriginalName = tagname.toUpperCase();
              switch (tagname) {
                case 'translator':
                  self.specialTagName = 'NCATS Biomedical Data Translator';
                  self.specialTagImage = '/static/img/ncats-logo.png';
                  self.specialTagURL = 'https://ncats.nih.gov/translator';
                  break;
                  case 'nihdatacommons' || 'NIHdatacommons':
                    self.specialTagName = 'NIH Data Commons';
                    self.specialTagImage = '/static/img/nih-logo.png';
                    self.specialTagURL = 'https://commonfund.nih.gov/commons';
                    break;
                default:
                  self.specialTagName = tagname.toUpperCase();
                  self.specialTagImage = '/static/img/logo-small.png';
                  self.specialTagURL = 'https://smart-api.info';
              }
              for (var i = 0; i < self.tags.length; i++) {
                if (self.tags[i].name.toLowerCase() === tagname.toLowerCase()) {
                  self.tags[i].active = true;
                }
              }
          },
          checkforQuery: function(){
            var url_string = window.location.href
            var url = new URL(url_string);
            var q = url.searchParams.get("q");
            if (q) {
              this.query = q;
            }
          },
          getAnalytics(){
            var self = this;
            axios.get('	https://gasuperproxy-1470690417190.appspot.com/query?id=ahxzfmdhc3VwZXJwcm94eS0xNDcwNjkwNDE3MTkwchULEghBcGlRdWVyeRiAgIDMgsmRCgw').then(res=>{
              if (res.data.rows) {
                var payload = {};
                payload["analytics"] = res.data.rows;
                store.commit('saveAnalytics',payload);
              }
               self.popularTags = _.orderBy(store.getters.getTags, ['name'],['desc'])

            }).catch(err=>{
              throw err;
            });
          }

      },
      created: function () {
          this.getUserInfo();
          this.getBTEapis();
          $(".button-collapse").sideNav();
          $('.collapsible').collapsible();
          this.loadFilters();
          this.context = {{Context}};

      },
      mounted:function(){

        this.getAnalytics();

        tippy( '#tippyParentCopy', {
          target: '.copyBtn',
          content:'Copied',
          animateFill: false,
          animation: 'fade',
          theme:'light',
          trigger:'click'});

      },
      updated: function(){
        // Highlight matches in results
        this.getKeywords();
      },
      computed: {
          paginatedApis: function () {
              var start = (this.page - 1) * this.perPage,
                  end = start + this.perPage;
              return this.apis && this.apis.slice(start, end);
          },
      },
      watch:{
        sort: function(sort){
          var self = this;
          switch (sort) {
            case 'Alpabethically A-Z':
            self.apis = _.sortBy(self.apis,'info.title');
              break;
            case 'Alpabethically Z-A':
            self.apis = _.sortBy(self.apis,'info.title').reverse();
            break;
            case 'Recently Updated':
            self.apis = _.sortBy(self.apis,'._meta.timestamp').reverse();
            break;
            case 'Search Relevance':
            self.search();
            break;
            default:
            self.apis = _.sortBy(self.apis,'info.title');
          }
        },
        apis: function(apis,oldapis){
          var self = this;
          for (var i = 0; i < apis.length; i++) {
            self.$set(apis[i], 'showDetails', false);
          }
        }
      }
  });
</script>
{% endblock %}
